---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";

const allPosts = await getCollection("posts");
const sortedPosts = allPosts.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

// Group posts by year
const postsByYear = new Map();
sortedPosts.forEach((post) => {
	const year = post.data.pubDate.getFullYear();
	if (!postsByYear.has(year)) {
		postsByYear.set(year, []);
	}
	postsByYear.get(year).push(post);
});

// Get all categories
const categoriesMap = new Map();
allPosts.forEach((post) => {
	post.data.categories.forEach((cat) => {
		categoriesMap.set(cat, (categoriesMap.get(cat) || 0) + 1);
	});
});
const categories = Array.from(categoriesMap.entries()).sort((a, b) => b[1] - a[1]);

// Get all tags
const tagsMap = new Map();
allPosts.forEach((post) => {
	post.data.tags.forEach((tag) => {
		tagsMap.set(tag, (tagsMap.get(tag) || 0) + 1);
	});
});
const tags = Array.from(tagsMap.entries()).sort((a, b) => b[1] - a[1]);

function getPostUrl(post: any) {
	// post.slug already includes year/month/slug from the file path
	return `/${post.slug}/`;
}

function slugify(text: string) {
	return text.toLowerCase().replace(/\s+/g, "-");
}
---

<BaseLayout title="Archive" description="Browse all posts by year, category, or tag">
	<div class="max-w-6xl mx-auto px-4 py-12">
		<h1 class="text-4xl font-bold mb-8 text-gray-800">Archive</h1>

		<!-- View tabs -->
		<div class="mb-8 border-b border-gray-200">
			<div class="flex gap-8">
				<button
					class="tab-btn active pb-4 px-2 font-sans font-semibold text-orange-600 border-b-2 border-orange-600"
					data-tab="years"
				>
					By Year
				</button>
				<button
					class="tab-btn pb-4 px-2 font-sans font-semibold text-gray-600 hover:text-gray-800"
					data-tab="categories"
				>
					By Category
				</button>
				<button
					class="tab-btn pb-4 px-2 font-sans font-semibold text-gray-600 hover:text-gray-800"
					data-tab="tags"
				>
					By Tag
				</button>
			</div>
		</div>

		<!-- By Year -->
		<div id="years-content" class="tab-content">
			<div class="space-y-8">
				{
					Array.from(postsByYear.entries()).map(([year, posts]) => (
						<div class="bg-white rounded-lg border border-gray-200 p-6">
							<h2 class="text-2xl font-bold mb-4 text-gray-800">
								{year}
								<span class="text-lg text-gray-500 font-normal">
									({posts.length} {posts.length === 1 ? "post" : "posts"})
								</span>
							</h2>
							<ul class="space-y-2">
								{posts.map((post: any) => (
									<li class="flex justify-between items-start">
										<a href={getPostUrl(post)} class="text-gray-700 hover:text-orange-600 flex-1">
											{post.data.title}
										</a>
										<span class="text-sm text-gray-500 ml-4 whitespace-nowrap">
											{post.data.pubDate.toLocaleDateString("en-US", {
												month: "short",
												day: "numeric",
											})}
										</span>
									</li>
								))}
							</ul>
						</div>
					))
				}
			</div>
		</div>

		<!-- By Category -->
		<div id="categories-content" class="tab-content hidden">
			<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
				{
					categories.map(([category, count]) => (
						<a
							href={`/category/${slugify(category)}/`}
							class="block bg-white rounded-lg border border-gray-200 p-6 hover:border-orange-600 hover:shadow-lg transition-all no-underline"
						>
							<h3 class="text-xl font-bold text-gray-800 mb-2">{category}</h3>
							<p class="text-gray-600 text-sm">
								{count} {count === 1 ? "post" : "posts"}
							</p>
						</a>
					))
				}
			</div>
		</div>

		<!-- By Tag -->
		<div id="tags-content" class="tab-content hidden">
			<div class="flex flex-wrap gap-3">
				{
					tags.map(([tag, count]) => (
						<a
							href={`/tag/${slugify(tag)}/`}
							class="inline-block px-4 py-2 bg-gray-100 hover:bg-orange-100 text-gray-700 hover:text-orange-700 rounded-full font-sans no-underline transition-colors"
							style={`font-size: ${Math.min(1.5, 0.875 + count / 50)}rem`}
						>
							#{tag} ({count})
						</a>
					))
				}
			</div>
		</div>
	</div>
</BaseLayout>

<script>
	// Tab switching functionality
	const tabButtons = document.querySelectorAll(".tab-btn");
	const tabContents = document.querySelectorAll(".tab-content");

	tabButtons.forEach((button) => {
		button.addEventListener("click", () => {
			const tabName = button.getAttribute("data-tab");

			// Update active button
			tabButtons.forEach((btn) => {
				btn.classList.remove("active", "text-orange-600", "border-b-2", "border-orange-600");
				btn.classList.add("text-gray-600");
			});
			button.classList.add("active", "text-orange-600", "border-b-2", "border-orange-600");
			button.classList.remove("text-gray-600");

			// Show corresponding content
			tabContents.forEach((content) => {
				content.classList.add("hidden");
			});
			document.getElementById(`${tabName}-content`)?.classList.remove("hidden");
		});
	});
</script>
