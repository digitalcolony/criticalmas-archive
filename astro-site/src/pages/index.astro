---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import PostCard from "../components/PostCard.astro";

// Get all posts and sort by date (newest first)
const allPosts = await getCollection("posts");
const sortedPosts = allPosts.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

// Get recent posts (first 15)
const recentPosts = sortedPosts.slice(0, 15);

// Get categories for sidebar
const categoriesMap = new Map();
allPosts.forEach((post) => {
	post.data.categories.forEach((cat) => {
		categoriesMap.set(cat, (categoriesMap.get(cat) || 0) + 1);
	});
});
const topCategories = Array.from(categoriesMap.entries())
	.sort((a, b) => b[1] - a[1])
	.slice(0, 10);

function getPostUrl(post: any) {
	// post.slug already includes year/month/slug from the file path
	return `/${post.slug}/`;
}
---

<BaseLayout title="Critical MAS" description="An archived blog - Better Living, Risk Adjusted">
	<div class="max-w-6xl mx-auto px-4 py-12">
		<div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
			<!-- Main content -->
			<div class="lg:col-span-2">
				<div class="space-y-8">
					{
						recentPosts.map((post) => (
							<PostCard
								title={post.data.title}
								slug={post.slug}
								pubDate={post.data.pubDate}
								url={getPostUrl(post)}
								categories={post.data.categories}
								excerpt={post.data.description}
								commentCount={post.data.commentCount}
							/>
						))
					}
				</div>

				<div class="mt-12 text-center">
					<a href="/archive" class="text-lg font-semibold"> View All Posts → </a>
				</div>
			</div>

			<!-- Sidebar -->
			<aside class="lg:col-span-1">
				<div class="sticky top-8">
					<div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
						<h3 class="text-xl font-bold mb-4 text-gray-800">About</h3>
						<p class="text-gray-700 text-sm leading-relaxed mb-4">
							Critical MAS is an archived personal blog covering fitness, nutrition, and various
							other topics from 2005 to 2025.
						</p>
						<a href="/about" class="text-orange-600 hover:text-orange-700 text-sm font-semibold">
							Read more →
						</a>
					</div>

					<div class="bg-white rounded-lg border border-gray-200 p-6">
						<h3 class="text-xl font-bold mb-4 text-gray-800">Categories</h3>
						<ul class="space-y-2">
							{
								topCategories.map(([category, count]) => (
									<li>
										<a
											href={`/category/${category.toLowerCase().replace(/\s+/g, "-")}/`}
											class="flex justify-between items-center text-gray-700 hover:text-orange-600 no-underline font-sans"
										>
											<span>{category}</span>
											<span class="text-sm text-gray-500">({count})</span>
										</a>
									</li>
								))
							}
						</ul>
						<a
							href="/archive"
							class="block mt-4 text-orange-600 hover:text-orange-700 text-sm font-semibold"
						>
							View all categories →
						</a>
					</div>
				</div>
			</aside>
		</div>
	</div>
</BaseLayout>
